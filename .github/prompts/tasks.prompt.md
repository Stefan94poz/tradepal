---
mode: agent
---

# Implementation Plan

- [ ] 1. Set up project structure and initialize Medusa.js backend
  - Initialize Medusa.js project with PostgreSQL and Redis configuration
  - Configure environment variables for database, Redis, and external services
  - Set up TypeORM with custom entity directory structure
  - Configure file storage with S3-compatible service
  - _Requirements: All requirements depend on proper project setup_

- [ ] 2. Implement custom data models and database migrations
  - [ ] 2.1 Create Seller Profile entity extending Medusa Customer
    - Define SellerProfile entity with company_name, business_type, location, certifications, verification_status fields
    - Create database migration for seller_profiles table with proper indexes
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_
  - [ ] 2.2 Create Buyer Profile entity extending Medusa Customer
    - Define BuyerProfile entity with company_name, business_interests, business_needs, location, verification_status fields
    - Create database migration for buyer_profiles table with proper indexes
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_
  - [ ] 2.3 Create Partner Directory Profile entity
    - Define PartnerDirectoryProfile entity with company_name, country, industry, looking_for, offers fields
    - Create database migration with GIN indexes for array fields and full-text search on company_name
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_
  - [ ] 2.4 Create Escrow Transaction entity
    - Define EscrowTransaction entity with order_id, buyer_id, seller_id, amount, status, payment_intent_id fields
    - Create database migration with unique constraint on order_id
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_
  - [ ] 2.5 Create Shipment Tracking entity
    - Define ShipmentTracking entity with order_id, carrier, tracking_number, status, tracking_events fields
    - Create database migration with unique constraint on order_id
    - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_
  - [ ] 2.6 Create Verification Documents entity
    - Define VerificationDocuments entity with user_id, document_urls, status, submission_date fields
    - Create database migration with indexes on user_id and status
    - _Requirements: 1.5, 4.5, 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 3. Implement VerificationService for profile verification
  - [ ] 3.1 Create VerificationService class with core methods
    - Implement submitVerification method to store documents and create verification request
    - Implement getVerificationStatus method to retrieve current verification state
    - Implement listPendingVerifications method for admin dashboard
    - _Requirements: 7.1, 7.5_
  - [ ] 3.2 Implement verification approval and rejection logic
    - Implement approveVerification method to update profile status and send notification
    - Implement rejectVerification method with reason tracking
    - Add email notification integration for approval/rejection events
    - _Requirements: 7.3, 7.4_

- [ ] 4. Implement EscrowService for secure payment handling
  - [ ] 4.1 Create EscrowService class with payment gateway integration
    - Implement createEscrow method to hold payment when order is accepted
    - Integrate with Stripe payment intents API for fund holding
    - _Requirements: 9.1, 9.2_
  - [ ] 4.2 Implement escrow release and dispute logic
    - Implement releaseEscrow method with buyer confirmation validation
    - Implement disputeEscrow method to flag transactions for admin review
    - Implement refundEscrow method for admin-initiated refunds
    - Add automatic fund release after 24 hours of delivery confirmation
    - _Requirements: 9.3, 9.4, 9.5_

- [ ] 5. Implement PartnerSearchService for B2B networking
  - [ ] 5.1 Create PartnerSearchService with search functionality
    - Implement searchPartners method with filters for country, industry, looking_for, offers
    - Add full-text search on company_name field
    - Implement pagination with 20 results per page
    - Filter results to only show verified profiles
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_
  - [ ] 5.2 Implement partner profile management
    - Implement createPartnerProfile method to create directory entry
    - Implement updatePartnerProfile method for profile updates
    - Implement getPartnerProfile method to retrieve profile details
    - _Requirements: 6.1, 6.5_

- [ ] 6. Implement ShipmentTrackingService for order tracking
  - [ ] 6.1 Create ShipmentTrackingService with carrier integration
    - Implement addTracking method to store tracking information
    - Implement getTrackingDetails method to retrieve current tracking state
    - Integrate with shipping carrier APIs (start with one major carrier)
    - _Requirements: 10.1, 10.2, 10.3_
  - [ ] 6.2 Implement automatic tracking updates
    - Implement updateTrackingStatus method to fetch updates from carrier API
    - Set up scheduled job to update tracking every 4 hours
    - Implement notification system for status changes
    - Add automatic buyer/seller notification when status changes to delivered
    - _Requirements: 10.4, 10.5_

- [ ] 7. Create custom API endpoints for verification
  - [ ] 7.1 Implement store verification endpoints
    - Create POST /store/verification/submit endpoint for document submission
    - Create GET /store/verification/status endpoint to check verification status
    - Add authentication middleware to verify user identity
    - _Requirements: 7.1_
  - [ ] 7.2 Implement admin verification endpoints
    - Create GET /admin/verifications endpoint to list pending verifications
    - Create POST /admin/verifications/:id/approve endpoint for approval
    - Create POST /admin/verifications/:id/reject endpoint with reason parameter
    - Add admin role authorization middleware
    - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 8. Create custom API endpoints for escrow management
  - [ ] 8.1 Implement store escrow endpoints
    - Create POST /store/orders/:id/escrow/release endpoint for buyer delivery confirmation
    - Create POST /store/orders/:id/escrow/dispute endpoint for dispute flagging
    - Create GET /store/orders/:id/escrow endpoint to retrieve escrow status
    - Add validation to ensure only buyer can release and both parties can dispute
    - _Requirements: 9.3, 9.4, 9.5_
  - [ ] 8.2 Implement admin escrow endpoints
    - Create POST /admin/escrow/:id/refund endpoint for admin refunds
    - Create GET /admin/escrow endpoint to list all escrow transactions
    - Add admin role authorization middleware
    - _Requirements: 9.4, 11.2, 11.3_

- [ ] 9. Create custom API endpoints for partner directory
  - Create GET /store/partners/search endpoint with query parameters for filters
  - Create POST /store/partners/profile endpoint for profile creation/update
  - Create GET /store/partners/:id endpoint to retrieve partner profile details
  - Add authentication middleware and verification status check
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 10. Create custom API endpoints for shipment tracking
  - Create POST /store/orders/:id/tracking endpoint for sellers to add tracking info
  - Create GET /store/orders/:id/tracking endpoint to retrieve tracking details
  - Create PUT /store/orders/:id/tracking/refresh endpoint for manual tracking updates
  - Add role-based authorization (sellers can add, both parties can view)
  - _Requirements: 10.1, 10.2, 10.3, 10.4_

- [ ] 11. Extend Medusa order workflow for B2B operations
  - [ ] 11.1 Customize order creation flow
    - Override order creation to support B2B-specific fields (bulk quantities, delivery terms)
    - Add seller notification when new order is created
    - Implement order acceptance/decline functionality for sellers
    - _Requirements: 8.1, 8.2, 8.3, 8.4_
  - [ ] 11.2 Integrate escrow with order workflow
    - Add escrow creation hook when seller accepts order
    - Update order status based on escrow state transitions
    - Implement order completion when escrow is released
    - _Requirements: 8.5, 9.1, 9.3_

- [ ] 12. Implement product management for sellers
  - [ ] 12.1 Extend Medusa product service for B2B features
    - Add B2B-specific product fields (minimum order quantity, bulk pricing tiers)
    - Implement product CRUD operations in seller dashboard context
    - Add product visibility controls (draft, published)
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_
  - [ ] 12.2 Implement product search and filtering
    - Create global product search endpoint with full-text search
    - Implement filters for category, price range, seller location, minimum order quantity
    - Add pagination with 20 products per page
    - Optimize search queries with proper indexes
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 13. Initialize Next.js frontend project
  - Create Next.js 14+ project with App Router
  - Install and configure Tailwind CSS
  - Set up shadcn/ui component library
  - Configure environment variables for API endpoints
  - Set up authentication context and API client utilities
  - _Requirements: All frontend requirements depend on proper project setup_

- [ ] 14. Implement authentication and registration flows
  - [ ] 14.1 Create login and registration pages
    - Build login page with email/password form
    - Build registration page with role selection (seller/buyer)
    - Create role-specific registration forms with required fields
    - Integrate with Medusa auth API endpoints
    - _Requirements: 1.1, 1.2, 4.1, 4.2_
  - [ ] 14.2 Implement authentication context and protected routes
    - Create AuthContext for managing user session state
    - Implement protected route wrapper for role-based access
    - Add automatic token refresh logic
    - Create logout functionality
    - _Requirements: All requirements depend on authentication_

- [ ] 15. Build seller dashboard and product management UI
  - [ ] 15.1 Create seller dashboard layout and navigation
    - Build dashboard layout with sidebar navigation
    - Create dashboard home page with key metrics (total products, pending orders)
    - Implement navigation to products, orders, and profile sections
    - _Requirements: 2.1, 12.1_
  - [ ] 15.2 Implement product management interface
    - Build product list page with table view and action buttons
    - Create product creation form with image upload, description, pricing fields
    - Create product edit form with pre-populated data
    - Implement product deletion with confirmation dialog
    - Add B2B-specific fields (minimum order quantity, bulk pricing)
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_
  - [ ] 15.3 Build seller profile management page
    - Create profile form with company information, location, certifications
    - Implement document upload for verification
    - Display verification status with badge
    - Add profile update functionality
    - _Requirements: 1.2, 1.3, 1.4, 1.5_

- [ ] 16. Build public seller store pages
  - [ ] 16.1 Create public seller store page layout
    - Build store page with seller header component (company info, verification badge)
    - Display seller description, location, and contact details
    - Create product catalog section with grid layout
    - _Requirements: 3.1, 3.2, 3.4_
  - [ ] 16.2 Implement product catalog with search and filters
    - Add search input for filtering products by name
    - Implement category and price range filters
    - Display products using ProductCard components
    - Add pagination controls
    - _Requirements: 3.3, 3.5_

- [ ] 17. Build buyer interface for product search and orders
  - [ ] 17.1 Create global product search page
    - Build search page with search input and filter sidebar
    - Implement filters for category, price, seller location, minimum order quantity
    - Display search results using ProductCard components with seller information
    - Add pagination controls
    - Link product cards to seller store pages
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_
  - [ ] 17.2 Build buyer profile management page
    - Create profile form with company information, business interests, business needs
    - Implement document upload for verification
    - Display verification status with badge
    - Add profile update functionality
    - _Requirements: 4.2, 4.3, 4.4, 4.5_
  - [ ] 17.3 Create buyer order history and tracking page
    - Build order list page with table view and status filters
    - Create order detail page with product information, seller details, and order status
    - Integrate escrow status display with EscrowStatusCard component
    - Integrate shipment tracking with TrackingTimeline component
    - Add delivery confirmation button for escrow release
    - _Requirements: 8.1, 9.5, 10.3, 10.5_

- [ ] 18. Build partner directory interface
  - [ ] 18.1 Create partner search page
    - Build search page with filter sidebar for country, industry, looking_for, offers
    - Add company name search input
    - Display search results with company cards showing key information
    - Add pagination controls
    - Link to partner profile detail pages
    - _Requirements: 6.1, 6.2, 6.3, 6.4_
  - [ ] 18.2 Implement partner profile pages
    - Create public partner profile page displaying company information
    - Show verification badge for verified partners
    - Display what they're looking for and what they offer
    - Add contact button for verified users
    - _Requirements: 6.5_

- [ ] 19. Build seller order management interface
  - [ ] 19.1 Create seller order dashboard
    - Build order list page with table view showing all incoming orders
    - Implement status filters (pending, accepted, shipped, completed)
    - Add date range filter
    - Display order details including buyer information and products
    - _Requirements: 12.1, 12.2, 12.3_
  - [ ] 19.2 Implement order action functionality
    - Add accept/decline buttons for pending orders
    - Create form for adding shipment tracking information
    - Implement order status update functionality
    - Display buyer contact information and delivery address
    - _Requirements: 8.3, 8.4, 8.5, 10.1, 12.4, 12.5_

- [ ] 20. Build administrator dashboard
  - [ ] 20.1 Create admin dashboard layout and navigation
    - Build admin dashboard layout with sidebar navigation
    - Create dashboard home page with platform metrics
    - Implement navigation to verifications, escrow, and settings sections
    - _Requirements: 11.1, 11.4_
  - [ ] 20.2 Implement verification management interface
    - Build verification queue page listing pending verifications
    - Create verification detail view with document preview
    - Add approve/reject buttons with rejection reason form
    - Display verification history and status
    - _Requirements: 7.1, 7.2, 7.3, 7.4_
  - [ ] 20.3 Build escrow management interface
    - Create escrow transaction list page with filters
    - Build escrow detail view showing transaction timeline
    - Implement dispute resolution interface with refund action
    - Display buyer and seller information for each transaction
    - _Requirements: 11.2, 11.3_
  - [ ] 20.4 Create platform settings page
    - Build settings form for commission rates and payment methods
    - Add verification requirement configuration
    - Implement platform-wide announcement system
    - _Requirements: 11.4_

- [ ] 21. Implement shared UI components with shadcn/ui
  - [ ] 21.1 Create product and business card components
    - Build ProductCard component with image, name, price, seller info, and action buttons
    - Build SellerStoreHeader component with company info and verification badge
    - Build VerificationBadge component with status indicator and tooltip
    - _Requirements: 3.2, 3.3, 3.4, 5.5_
  - [ ] 21.2 Create order and transaction components
    - Build OrderTable component with filtering, sorting, and action buttons
    - Build EscrowStatusCard component with status display and action buttons
    - Build TrackingTimeline component with shipment event visualization
    - _Requirements: 9.5, 10.3, 12.1_
  - [ ] 21.3 Create search and filter components
    - Build PartnerSearchFilters component with multi-select filters
    - Build ProductSearchFilters component with category, price, location filters
    - Create reusable SearchInput component with debouncing
    - _Requirements: 5.3, 5.4, 6.2, 6.3_

- [ ] 22. Implement notification system
  - [ ] 22.1 Create notification service in backend
    - Implement email notification service with template support
    - Create notification templates for verification, orders, escrow, shipment events
    - Add notification preferences to user profiles
    - _Requirements: 7.3, 7.4, 8.2, 10.5_
  - [ ] 22.2 Build in-app notification UI
    - Create notification bell icon with unread count in header
    - Build notification dropdown with recent notifications
    - Implement notification list page with filtering
    - Add real-time notification updates using polling or WebSockets
    - _Requirements: 8.2, 9.1, 10.5_

- [ ] 23. Implement file upload and storage
  - Create file upload utility for product images and verification documents
  - Integrate with S3-compatible storage service
  - Implement image optimization and resizing for product images
  - Add file type and size validation
  - Generate signed URLs for secure document access
  - _Requirements: 1.4, 1.5, 2.2, 4.5_

- [ ] 24. Set up payment gateway integration
  - [ ] 24.1 Integrate Stripe for payment processing
    - Set up Stripe account and API keys
    - Implement payment intent creation for escrow
    - Add webhook handlers for payment events
    - _Requirements: 9.1, 9.2_
  - [ ] 24.2 Build payment UI components
    - Create payment form with Stripe Elements
    - Build payment confirmation page
    - Implement payment error handling and retry logic
    - _Requirements: 9.1, 9.5_

- [ ] 25. Integrate shipping carrier APIs
  - Research and select primary shipping carriers (e.g., DHL, FedEx, UPS)
  - Implement carrier API integration for tracking updates
  - Create carrier adapter pattern for supporting multiple carriers
  - Add fallback for manual tracking entry when API is unavailable
  - _Requirements: 10.2, 10.3, 10.4_

- [ ] 26. Implement search optimization
  - Add full-text search indexes on product names and descriptions
  - Implement search result ranking algorithm
  - Add search query caching with Redis
  - Optimize database queries with proper indexes
  - _Requirements: 5.1, 5.2, 6.2_

- [ ] 27. Set up monitoring and error tracking
  - Integrate Sentry for error tracking in both frontend and backend
  - Set up application logging with structured logs
  - Create custom metrics for business events (orders, verifications, escrow)
  - Implement health check endpoints for monitoring
  - _Requirements: All requirements benefit from monitoring_

- [ ] 28. Configure deployment pipeline
  - [ ] 28.1 Set up Docker containers
    - Create Dockerfile for Medusa.js backend
    - Create Dockerfile for Next.js frontend
    - Create docker-compose.yml for local development
    - _Requirements: All requirements depend on deployment_
  - [ ] 28.2 Configure CI/CD with GitHub Actions
    - Create workflow for running tests on pull requests
    - Add workflow for building and pushing Docker images
    - Implement deployment workflow for staging and production
    - Add environment-specific configuration management
    - _Requirements: All requirements depend on deployment_

- [ ]\* 29. Write integration tests for critical flows
  - [ ]\* 29.1 Test seller registration and verification flow
    - Write test for seller registration with profile creation
    - Test verification document submission and approval process
    - Verify seller can access dashboard after verification
    - _Requirements: 1.1, 1.2, 1.5, 7.1, 7.3_
  - [ ]\* 29.2 Test order and escrow flow
    - Write test for complete order flow from creation to completion
    - Test escrow creation when order is accepted
    - Test escrow release on delivery confirmation
    - Test dispute flagging and admin resolution
    - _Requirements: 8.1, 8.4, 8.5, 9.1, 9.3, 9.4_
  - [ ]\* 29.3 Test product search and partner directory
    - Write test for global product search with filters
    - Test partner directory search with multiple filter combinations
    - Verify only verified profiles appear in partner directory
    - _Requirements: 5.1, 5.3, 5.4, 6.2, 6.3, 6.5_

- [ ]\* 30. Create API documentation
  - Document all custom API endpoints with request/response examples
  - Create Postman collection for API testing
  - Generate OpenAPI/Swagger specification
  - Write integration guide for external developers
  - _Requirements: All API-related requirements_
